#!/usr/bin/env python3

import os
import json
import subprocess

print("Starting configuration...")
config_dir = os.path.join(os.environ['SNAP_COMMON'], 'conf')

# Function to get snap configuration value using snapctl
def snapctl_get(key):
    result = subprocess.run(['snapctl', 'get', key], capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"Failed to get snap configuration for key: {key}")
    return result.stdout.strip()

def save_json(data, path):
    print(f"Writing configuration to {path}")
    with open(path, 'w') as f:
        json_str = json.dumps(data, indent=4)
        print(json_str)
        f.write(json_str)
        print(f"Data saved to {path}")

bootstrap_path = os.path.join(config_dir, 'bootstrap.json')
bootstrap_data_str = snapctl_get('bootstrap')
bootstrap_data = json.loads(bootstrap_data_str)
save_json(bootstrap_data, bootstrap_path)

conf_path = os.path.join(config_dir, 'conf.json')
conf_data_str = snapctl_get('conf')
conf_data = json.loads(conf_data_str)
save_json(conf_data, conf_path)

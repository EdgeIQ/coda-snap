name: Publish Snap

on:
  workflow_dispatch:
    inputs:
      EDGEIQ_CODA_VERSION:
        description: 'Version of the snap'
        required: true
      SNAPCRAFT_CHANNELS:
        description: 'Channels for publication (comma-separated)'
        required: false
        default: 'edge,beta,candidate,stable'

jobs:
  build-and-publish:
    name: Build and Publish Snap
    runs-on: ubuntu-latest
    env:
      EDGEIQ_SNAP_NAME: coda
      EDGEIQ_API_URL: https://api.edgeiq.io
      EDGEIQ_CODA_VERSION: ${{ github.event.inputs.EDGEIQ_CODA_VERSION }}
      SNAPCRAFT_CHANNELS: ${{ github.event.inputs.SNAPCRAFT_CHANNELS }}
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install Snapcraft
        run: sudo snap install snapcraft --classic

      - name: Run template to generate snapcraft.yaml
        run: make template

      - name: Build and publish snap for amd64, arm64, and armhf
        run: |
          snapcraft remote-build --build-on=amd64,arm64,armhf --status --launchpad-accept-public-upload --launchpad-timeout 3600 --package-all-sources
          
      - name: Publish to specified channels
        run: |
          echo "Publishing to channels: $SNAPCRAFT_CHANNELS"
          IFS=',' read -ra CHANNELS <<< "$SNAPCRAFT_CHANNELS"
          for channel in "${CHANNELS[@]}"; do
            echo "Publishing to channel: $channel"
            snapcraft push *.snap --release="$channel"
            echo "Published to $channel"
          done
          echo "All publishing completed"